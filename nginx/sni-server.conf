# SNI proxy configuration - static parts
# The domain map is generated at runtime and included below

include /etc/nginx/stream.d/sni-map.conf;

# Log format for debugging
log_format sni_log '$remote_addr - [$time_local] SNI:$ssl_preread_server_name -> $sni_upstream $status';

# SNI proxy server
server {
    listen 8443;

    # DNS resolver for upstream hostname resolution
    resolver 8.8.8.8 1.1.1.1 valid=300s ipv6=off;
    resolver_timeout 5s;

    # Enable SNI inspection (reads SNI without decrypting)
    ssl_preread on;

    # Access logging for debugging
    access_log /var/log/nginx/sni-proxy.log sni_log;

    # If upstream is empty (not whitelisted), nginx will close the connection
    # If upstream is set, proxy the connection transparently
    proxy_pass $sni_upstream;

    # Timeout settings
    proxy_connect_timeout 10s;
    proxy_timeout 300s;
}
