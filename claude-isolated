#!/bin/bash
# Claude Code Isolated - Wrapper script for containerized Claude Code
# Usage: ./claude-isolated [claude arguments...]

set -e

# Ensure we have a workspace to mount
if [ ! -d "$(pwd)" ]; then
    echo "Error: Current directory does not exist"
    exit 1
fi

# Detect if running in interactive terminal
if [ -t 0 ] && [ -t 1 ]; then
    INTERACTIVE_FLAGS="-it"
else
    INTERACTIVE_FLAGS=""
fi

# Run Claude Code in isolated container with Docker-in-Docker
# --privileged is required for Docker daemon to run inside container
# --hostname=claude-isolated provides consistent identity across container runs
# Mount workspace at same path as host so Claude can track sessions per project
# Mount host .claude directory directly (sessions, todos, deny rules all work)
# Each container instance runs its own Docker daemon with isolated network/ports
# Pass through TERM and COLORTERM for proper color support
# Use --permission-mode bypassPermissions for YOLO mode (no prompts)
WORKSPACE_PATH="$(pwd)"

# Parse CLAUDE_UNCHAINED_EXTRA_MOUNTS environment variable
# Format: space-separated mount specs (e.g., "/host/path:/container/path:ro /another:/path")
EXTRA_MOUNT_FLAGS=""
if [ -n "$CLAUDE_UNCHAINED_EXTRA_MOUNTS" ]; then
    for mount in $CLAUDE_UNCHAINED_EXTRA_MOUNTS; do
        EXTRA_MOUNT_FLAGS="$EXTRA_MOUNT_FLAGS -v $mount"
    done
fi

docker run --rm $INTERACTIVE_FLAGS \
    --privileged \
    --hostname=claude-isolated \
    -e CLAUDE_CONFIG_DIR=/home/claude/.claude \
    -e CLAUDE_UNCHAINED_WHITELIST_DOMAINS="${CLAUDE_UNCHAINED_WHITELIST_DOMAINS:-}" \
    -e TERM="${TERM:-xterm-256color}" \
    -e COLORTERM="${COLORTERM:-truecolor}" \
    -w "$WORKSPACE_PATH" \
    -v "$WORKSPACE_PATH:$WORKSPACE_PATH" \
    -v "$HOME/.claude:/home/claude/.claude" \
    -v claude-pnpm-store:/home/claude/.local/share/pnpm/store \
    $EXTRA_MOUNT_FLAGS \
    claude-isolated --permission-mode bypassPermissions "$@"
