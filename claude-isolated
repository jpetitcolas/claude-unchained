#!/bin/bash
# Claude Code Isolated - Wrapper script for containerized Claude Code
# Usage: ./claude-isolated [claude arguments...]

set -e

# Ensure we have a workspace to mount
if [ ! -d "$(pwd)" ]; then
    echo "Error: Current directory does not exist"
    exit 1
fi

# Detect if running in interactive terminal
if [ -t 0 ] && [ -t 1 ]; then
    INTERACTIVE_FLAGS="-it"
else
    INTERACTIVE_FLAGS=""
fi

# Run Claude Code in isolated container
# Mount host .claude for auth and config (sessions filtered by workspace path)
# --cap-add=NET_ADMIN is required for iptables firewall configuration
# CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS=1 allows autonomous operation within the isolated container
# CLAUDE_CONFIG_DIR tells Claude Code where to find config files
# --hostname=claude-isolated provides consistent identity across container runs
# Mount workspace at same path as host so Claude can track sessions per project
# Pass through TERM and COLORTERM for proper color support
WORKSPACE_PATH="$(pwd)"
docker run --rm $INTERACTIVE_FLAGS \
    --cap-add=NET_ADMIN \
    --hostname=claude-isolated \
    -e CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS=1 \
    -e CLAUDE_CONFIG_DIR=/home/claude/.claude \
    -e DEVCONTAINER=true \
    -e TERM="${TERM:-xterm-256color}" \
    -e COLORTERM="${COLORTERM:-truecolor}" \
    -w "$WORKSPACE_PATH" \
    -v "$WORKSPACE_PATH:$WORKSPACE_PATH" \
    -v "$HOME/.claude:/home/claude/.claude" \
    claude-isolated "$@"
